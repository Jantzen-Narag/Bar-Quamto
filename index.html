<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bar Quamto Q&A</title>
  <style>
    body {
      font-family: 'Times New Roman', serif;
      padding: 20px;
      text-align: center;
    }
    #question, #answer {
      margin: 40px auto;
      max-width: 80%;
      font-size: 28px;
      white-space: pre-wrap;
    }
    #answer {
      display: none;
      color: green;
    }
    #timer {
      position: absolute;
      top: 10px;
      left: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      margin: 10px;
    }
  </style>
</head>
<body>

<h1>Bar Quamto Random Q&A</h1>
<div id="timer">⏳ 12:00</div>
<div id="question">Press "Generate" to start</div>
<div id="answer"></div>

<button onclick="generateQA()">Generate</button>
<button onclick="toggleAnswer()">Show/Hide Answer</button>

<script>
const sheetID = '1Ga6gDNCJqlIRhawqiqw_vaNZ_W4maxv2OS_km6yGDMw';
const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

let allData = [];
let usedIndices = new Set();
let timerInterval;

async function fetchSheetData() {
  try {
    const res = await fetch(sheetURL);
    const text = await res.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;

    allData = rows.map(r => ({
      question: r.c[0]?.v || '',
      answer: r.c[1]?.v || ''
    })).filter(q => q.question && q.answer);

    console.log("Loaded", allData.length, "Q&A items");
  } catch (e) {
    alert("Failed to load Google Sheet");
    console.error(e);
  }
}

function generateQA() {
  if (allData.length === 0) {
    alert("Data not yet loaded.");
    return;
  }

  if (usedIndices.size === allData.length) {
    alert("All questions used! Resetting...");
    usedIndices.clear();
  }

  let index;
  do {
    index = Math.floor(Math.random() * allData.length);
  } while (usedIndices.has(index));
  usedIndices.add(index);

  const item = allData[index];
  document.getElementById('question').textContent = item.question;
  document.getElementById('answer').textContent = item.answer;
  document.getElementById('answer').style.display = 'none';

  startTimer(12 * 60); // 12 minutes
}

function toggleAnswer() {
  const answer = document.getElementById('answer');
  answer.style.display = (answer.style.display === 'none') ? 'block' : 'none';
}

function startTimer(seconds) {
  clearInterval(timerInterval);
  const timer = document.getElementById('timer');
  let remaining = seconds;

  function update() {
    const m = String(Math.floor(remaining / 60)).padStart(2, '0');
    const s = String(remaining % 60).padStart(2, '0');
    timer.textContent = `⏳ ${m}:${s}`;
    if (remaining <= 0) clearInterval(timerInterval);
    remaining--;
  }

  update();
  timerInterval = setInterval(update, 1000);
}

window.onload = fetchSheetData;
</script>

</body>
</html>
